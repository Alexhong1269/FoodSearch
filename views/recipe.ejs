<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Foogle - <%= recipe.Title %></title>
</head>
<body>
	<%- include('partials/navigation') %>
	
	<!-- Substitute ingredients -->
	<h2>Substitute ingredients for special diets:</h2>
	<h4>Disclaimer: Substitutes may occasionally contain mistakes since the dataset is large and partially generated by AI tools. Ensure that all ingredients are suitable for your diet. Adjust the quantity, instructions, and cook time accordingly.</h4>
	<select id="dietaryPreference">
		<option value="">Select Dietary Preference</option>
		<option value="Vegetarian">Vegetarian</option>
		<option value="Vegan">Vegan</option>
		<option value="GlutenFree">Gluten-free</option>
		<option value="Keto">Keto</option>
		<option value="Paleo">Paleo</option>
		<option value="Halal">Halal</option>
		<option value="Kosher">Kosher</option>
	</select>
	<p id="preference-description"></p>
	
	<!-- Recipe details -->
	<div>
		<h1><%= recipe.Title %></h1>
		<% if (recipe.PubDate) { %><p>Published on <%= new Date(recipe.PubDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %> by <%= recipe.Username %></p><% } %>
		<img src="<%= recipe.Img %>" alt="<%= recipe.Title %>">
		<p><%= recipe.TextDesc %></p>
		
		<% if (recipe.PrepTime) { %><p>Prep Time: <%= recipe.PrepTime >= 60 ? Math.floor(recipe.PrepTime / 60) + ' hours ' : '' %><%= recipe.PrepTime % 60 !== 0 ? recipe.PrepTime % 60 + ' minutes' : '' %></p><% } %>
		<% if (recipe.CookTime) { %><p>Cook Time: <%= recipe.CookTime >= 60 ? Math.floor(recipe.CookTime / 60) + ' hours ' : '' %><%= recipe.CookTime % 60 !== 0 ? recipe.CookTime % 60 + ' minutes' : '' %></p><% } %>
		<% if (recipe.AdditionalTime) { %><p>Additional Time: <%= recipe.AdditionalTime >= 60 ? Math.floor(recipe.AdditionalTime / 60) + ' hours ' : '' %><%= recipe.AdditionalTime % 60 !== 0 ? recipe.AdditionalTime % 60 + ' minutes' : '' %></p><% } %>
		<% if (recipe.PrepTime || recipe.CookTime || recipe.AdditionalTime) { %>
		<p>Total Time: <%=
			((recipe.PrepTime || 0) + (recipe.CookTime || 0) + (recipe.AdditionalTime || 0)) >= 60 ?
			Math.floor(((recipe.PrepTime || 0) + (recipe.CookTime || 0) + (recipe.AdditionalTime || 0)) / 60) + ' hours ' : ''
		%><%=
			((recipe.PrepTime || 0) + (recipe.CookTime || 0) + (recipe.AdditionalTime || 0)) % 60 !== 0 ?
			((recipe.PrepTime || 0) + (recipe.CookTime || 0) + (recipe.AdditionalTime || 0)) % 60 + ' minutes' : ''
		%></p><% } %>
		<% if (recipe.Servings) { %><p>Servings: <%= recipe.Servings %></p><% } %>
		<% if (recipe.Yield) { %><p>Yield: <%= recipe.Yield %></p><% } %>
		
		<h2>Ingredients</h2>
		<ul id="ingredientList">
			<% ingredients.forEach(ingredient => { %>
				<li
				data-ingredient-id="<%= ingredient.IngredientID %>"
				data-Vegetarian="<%= ingredient.Vegetarian %>"
				data-Vegan="<%= ingredient.Vegan %>"
				data-GlutenFree="<%= ingredient.GlutenFree %>"
				data-Keto="<%= ingredient.Keto %>"
				data-Paleo="<%= ingredient.Paleo %>"
				data-Halal="<%= ingredient.Halal %>"
				data-Kosher="<%= ingredient.Kosher %>">
					<%= ingredient.IngredientText %>
				</li>
			<% }); %>
		</ul>
		
		<h2>Instructions</h2>
		<ol>
			<% instructions.forEach(instruction => { %>
				<li><%= instruction.Instruction %></li>
			<% }); %>
		</ol>
		
		<h2>Ratings</h2>
		<ul>
			<li><button onclick="rateRecipe('<%= recipe.RecipeID %>', 5)">5 Stars: <%= ratings.Five %></button></li>
			<li><button onclick="rateRecipe('<%= recipe.RecipeID %>', 4)">4 Stars: <%= ratings.Four %></button></li>
			<li><button onclick="rateRecipe('<%= recipe.RecipeID %>', 3)">3 Stars: <%= ratings.Three %></button></li>
			<li><button onclick="rateRecipe('<%= recipe.RecipeID %>', 2)">2 Stars: <%= ratings.Two %></button></li>
			<li><button onclick="rateRecipe('<%= recipe.RecipeID %>', 1)">1 Star: <%= ratings.One %></button></li>
		</ul>		
	</div>
	
	<!-- Get substitutions -->
	<script>
		document.getElementById('dietaryPreference').addEventListener('change', async function() {
			const preference = this.value;
			if (!preference) return;
			
			const response = await fetch(`/category-desc?category=${preference}`);
			const data = await response.json();
			document.querySelector('#preference-description').textContent = data.recordset[0].Description;
			
			document.querySelectorAll('.substitution').forEach(sub => sub.remove());
			const ingredientList = document.querySelectorAll('#ingredientList li');
			
			for (let ingredient of ingredientList) {
				if (ingredient.getAttribute(`data-${preference}`) == 'Yes' || ingredient.getAttribute(`data-${preference}`) == 'Maybe') {
					continue;
				}
				
				const ingredientId = ingredient.getAttribute('data-ingredient-id');
				const response = await fetch(`/substitution?ingredientId=${ingredientId}&preference=${preference}`);
				const substitutionData = await response.json();
				
				const substitutionElement = document.createElement('div');
				substitutionElement.classList.add('substitution');
				if (substitutionData.Name) {
					if (preference == 'GlutenFree') {
						substitutionElement.textContent = `Gluten-free substitute: ${substitutionData.Name}`;
					} else {
						substitutionElement.textContent = `${preference} substitute: ${substitutionData.Name}`;
					}
				} else {
					substitutionElement.textContent = `${preference} substitute not found.`;
				}
				ingredient.appendChild(substitutionElement);
			}
		});
	</script>
	
	<script>
		function rateRecipe(recipeId, stars) {
			fetch('/rate-recipe', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ recipeId: recipeId, stars: stars })
			})
			.then(response => response.json())
			.then(data => {
				alert('Thank you for rating!');
				// Optionally update the UI here to show the new rating count
			})
			.then(res => window.location.reload())
			.catch(error => console.error('Error rating the recipe:', error));
		}
		</script>
</body>
</html>